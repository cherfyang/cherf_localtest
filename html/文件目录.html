<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8" />
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æ–‡ä»¶ç®¡ç†å™¨</title>
    <!-- æ ·å¼çœç•¥ï¼Œä½¿ç”¨ä½ ä¹‹å‰æä¾›çš„ style éƒ¨åˆ†ç²˜è´´åœ¨è¿™é‡Œ -->
    <style>
        /* ...ä½ çš„ CSS æ ·å¼ä¿æŒä¸å˜ï¼Œè¿™é‡Œçœç•¥... */
    </style>
</head>

<body>
<div class="main-container">
    <!-- ğŸ“ å·¦ä¾§ç›®å½•æ ‘ -->
    <div id="serverTree">
        <h2>æœåŠ¡å™¨ç›®å½•æ ‘</h2>
        <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹" />
        <div id="actionBars">
            <button class="upload-btn" onclick="deleteSelected()">ğŸ—‘ï¸ åˆ é™¤</button>
            <button class="upload-btn" onclick="renameSelected()">âœï¸ é‡å‘½å</button>
        </div>
        <ul id="directoryTree"></ul>
    </div>

    <!-- ğŸ“¤ å³ä¾§ä¸Šä¼ åŒºåŸŸ -->
    <div id="uploadSection">
        <h2>ä¸Šä¼ åˆ°: /</h2>
        <h2>ä¸Šä¼ æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</h2>
        <div id="dropArea">
            <p>æ‹–æ‹½æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åˆ°æ­¤å¤„ä¸Šä¼ </p>
        </div>
        <div id="actionBar">
            <button class="upload-btn" onclick="document.getElementById('folderInput').click()">ä¸Šä¼ æ–‡ä»¶å¤¹</button>
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">ä¸Šä¼ æ–‡ä»¶</button>
        </div>
        <input type="file" id="folderInput" webkitdirectory multiple style="display:none;" />
        <input type="file" id="fileInput" multiple style="display:none;" />
        <ul id="fileList"></ul>
    </div>
</div>

<!-- å³é”®èœå• -->
<div class="context-menu" id="contextMenu">
    <ul>
        <li onclick="downloadHighlighted()">ğŸ“¥ ä¸‹è½½</li>
        <li onclick="deleteSelected()">ğŸ—‘ï¸ åˆ é™¤</li>
        <li onclick="renameSelected()">âœï¸ é‡å‘½å</li>
        <li onclick="triggerUploadFile()">ğŸ“¤ ä¸Šä¼ æ–‡ä»¶</li>
        <li onclick="triggerUploadFolder()">ğŸ“ ä¸Šä¼ æ–‡ä»¶å¤¹</li>
    </ul>
</div>

<input type="file" id="contextFileInput" style="display: none;" multiple />
<input type="file" id="contextFolderInput" style="display: none;" webkitdirectory />

<script>
    // ä½ çš„ JS è„šæœ¬è¡¥å……åœ¨è¿™é‡Œï¼ˆå»ºè®®æ‹†åˆ†ä¸ºæ–‡ä»¶æ›´æ¸…æ™°ï¼‰
    const dropArea = document.getElementById('dropArea');
    const folderInput = document.getElementById('folderInput');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const directoryTree = document.getElementById('directoryTree');
    const searchInput = document.getElementById('searchInput');
    const contextMenu = document.getElementById('contextMenu');
    let selectedPaths = [];
    let contextTargetPath = '';

    document.addEventListener('DOMContentLoaded', loadDirectoryTree);

    function showContextMenu(x, y, path) {
        contextMenu.style.display = 'block';
        contextMenu.style.left = `${x}px`;
        contextMenu.style.top = `${y}px`;
        contextTargetPath = path.endsWith('/') ? path : path.substring(0, path.lastIndexOf('/') + 1);
    }

    function triggerUploadFile() {
        document.getElementById('contextFileInput').click();
    }

    function triggerUploadFolder() {
        document.getElementById('contextFolderInput').click();
    }

    document.getElementById('contextFileInput').addEventListener('change', function () {
        if (this.files.length > 0) {
            uploadFilesWithPath([...this.files], contextTargetPath);
            this.value = '';
        }
    });

    document.getElementById('contextFolderInput').addEventListener('change', function () {
        if (this.files.length > 0) {
            uploadFilesWithPath([...this.files], contextTargetPath);
            this.value = '';
        }
    });

    function loadDirectoryTree() {
        fetch('/api/file_directory')
            .then(res => res.json())
            .then(data => {
                directoryTree.innerHTML = generateTreeHTML(data);
                setupFolderToggles();
                setupSelectionEvents();
            });
    }

    function generateTreeHTML(node, currentPath = '') {
        let html = '<ul>';
        for (let key in node) {
            const value = node[key];
            const isFolder = typeof value === 'object';
            const fullPath = currentPath ? `${currentPath}/${key}` : key;

            if (isFolder) {
                html += `<li class="folder-toggle" data-path="${fullPath}">
                      ğŸ“ ${key}
                      <div class="folder-content">${generateTreeHTML(value, fullPath)}</div>
                   </li>`;
            } else {
                html += `<li class="file folder-item" data-path="${fullPath}" oncontextmenu="handleRightClick(event, '${fullPath}')">ğŸ“„ ${key}</li>`;
            }
        }
        html += '</ul>';
        return html;
    }

    function setupFolderToggles() {
        document.querySelectorAll('.folder-toggle').forEach(folder => {
            folder.addEventListener('click', function (e) {
                if (e.target !== this) return;
                const content = this.querySelector('.folder-content');
                content.style.display = content.style.display === 'block' ? 'none' : 'block';
            });
        });
    }

    function setupSelectionEvents() {
        document.querySelectorAll('.folder-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.folder-item').forEach(el => el.classList.remove('selected'));
                this.classList.add('selected');
                selectedPaths = [this.dataset.path];
            });
        });
    }

    function handleRightClick(e, path) {
        e.preventDefault();
        showContextMenu(e.pageX, e.pageY, path);
    }

    window.addEventListener('click', () => {
        contextMenu.style.display = 'none';
    });

    function deleteSelected() {
        if (selectedPaths.length === 0) return;
        fetch('/api/file_delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ paths: selectedPaths })
        })
            .then(res => res.json())
            .then(() => {
                alert('âœ… åˆ é™¤æˆåŠŸ');
                loadDirectoryTree();
            })
            .catch(() => alert('âŒ åˆ é™¤å¤±è´¥'));
    }

    function renameSelected() {
        if (selectedPaths.length !== 1) {
            alert('è¯·é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶æˆ–æ–‡ä»¶å¤¹é‡å‘½å');
            return;
        }
        const newName = prompt('è¯·è¾“å…¥æ–°åç§°:');
        if (!newName) return;
        fetch('/api/file_rename', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ oldPath: selectedPaths[0], newName })
        })
            .then(res => res.json())
            .then(() => {
                alert('âœ… é‡å‘½åæˆåŠŸ');
                loadDirectoryTree();
            })
            .catch(() => alert('âŒ é‡å‘½åå¤±è´¥'));
    }

    function downloadHighlighted() {
        if (selectedPaths.length !== 1) return;
        const link = document.createElement('a');
        link.href = `/api/file_download?path=${encodeURIComponent(selectedPaths[0])}`;
        link.download = '';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }

    function uploadFilesWithPath(files, targetPath = '/ych') {
        const formData = new FormData();
        files.forEach(file => {
            formData.append('files', file, file.webkitRelativePath || file.name);
        });
        fetch(`/api/v1/file/upload?path=${encodeURIComponent(targetPath)}`, {
            method: 'POST',
            body: formData
        })
            .then(res => res.json())
            .then(() => {
                alert('âœ… ä¸Šä¼ æˆåŠŸ');
                loadDirectoryTree();
            })
            .catch(() => alert('âŒ ä¸Šä¼ å¤±è´¥'));
    }

    // æ‹–æ”¾ä¸Šä¼ 
    dropArea.addEventListener('dragenter', e => { e.preventDefault(); dropArea.classList.add('highlight'); });
    dropArea.addEventListener('dragover', e => { e.preventDefault(); dropArea.classList.add('highlight'); });
    dropArea.addEventListener('dragleave', e => { e.preventDefault(); dropArea.classList.remove('highlight'); });
    dropArea.addEventListener('drop', async e => {
        e.preventDefault();
        dropArea.classList.remove('highlight');
        const items = e.dataTransfer.items;
        let files = [];
        for (let item of items) {
            let entry = item.webkitGetAsEntry();
            if (entry) {
                files = files.concat(await traverseFileTree(entry));
            }
        }
        uploadFilesWithPath(files);
    });

    function traverseFileTree(item, path = '') {
        return new Promise(resolve => {
            if (item.isFile) {
                item.file(file => {
                    file.relativePath = path + file.name;
                    resolve([file]);
                });
            } else if (item.isDirectory) {
                const dirReader = item.createReader();
                dirReader.readEntries(async entries => {
                    let files = [];
                    for (let entry of entries) {
                        files = files.concat(await traverseFileTree(entry, path + item.name + '/'));
                    }
                    resolve(files);
                });
            } else {
                resolve([]);
            }
        });
    }

    searchInput.addEventListener('input', () => {
        const keyword = searchInput.value.trim().toLowerCase();
        document.querySelectorAll('.folder-item').forEach(item => {
            const match = item.textContent.toLowerCase().includes(keyword);
            item.style.display = match ? 'block' : 'none';
            if (match) {
                item.classList.add('highlight-match');
            } else {
                item.classList.remove('highlight-match');
            }
        });
    });
</script>
</body>

</html>
